<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
<link rel="stylesheet" href="//code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css">
<script src="//code.jquery.com/jquery-1.12.0.min.js"></script>
<script src="//code.jquery.com/jquery-migrate-1.2.1.min.js"></script>
<link href="./css/qna.css" rel="stylesheet">

<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap-theme.min.css">


<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>
<script src ="https://code.jquery.com/jquery-1.11.2.js"></script>


</head>
<body>
<div id="wrap" class="qna">
     
   	 <div id="header"></div>
     <div id="sidebar"></div>
     
     <div id="content" align="center">
     <table width="600" align="center" id="basic_table">
     </table>
     
     
     <br/>
     <input class="btn btn-default" id="insert" type="button" value="입력" onclick="insertForm()">
     <input class="btn btn-default" id="update" type="button" value="수정" onclick="updateForm()">
     <input class="btn btn-default" id="delete" type="button" value="삭제" onclick="deleteQna()">
     <input class="btn btn-default" type="button" value="리스트" onclick="document.location.href='qnaList.html'">
     
     <br/><br/>
     
     <div id="replyList">
     
		<table class="table table-hover" width="500" align="center" id="reply_table">
        </table>
        <form action="/hair/board/insertReply.do" method="post" name="replyForm">
        
         <textarea class="form-control" rows="2" name="qnaReply_content" id="inputContent"></textarea><br/>
         <input type="hidden" name="qnaReply_nick"/>
         <input type="hidden" name="qna_no" />
         <input class="btn btn-default" type="submit" value="댓글등록" >
     </form>
	 </div>
	 
     
     
     
     
     <script>
     function getContextPath(){
 	    var offset=location.href.indexOf(location.host)+location.host.length;
 	    var ctxPath=location.href.substring(offset,location.href.indexOf('/',offset+1));
 	    return ctxPath;
 	}
 	var blogPath =  getContextPath();
 	var contextPath =  getContextPath();
        
 	
     
     	var no = location.href.split('?')[1].split('=')[1];
		var contextRoot = contextPath;
		
		var nickname = ""
		
		$.ajax(contextRoot + '/board/getSession.do',{
	 		dataType: 'json',
	 		method: 'GET',
	 		async: false,
	 		success: function(result) {
	 			nickname = result.nick;
	 		}
 		  });	 
		
		$.ajax(contextRoot + '/board/detail.do?qna_no=' + no, {
			dataType: 'json',
			method: 'GET',
			async: false,
			success: function(resultObj) {
				  var table = $("#basic_table");
				 //alert(resultObj);
				  var board = resultObj.data;
				  //alert(board.qna_title);
				    $("<tr>").html
				           ("<td colspan='4'><input type='text' size='83' class='form-control' id='qna_title' value="+board.qna_title+" name='qna_title' readonly></td></tr>").appendTo(table);
				    $("<tr>").html
				              ("<td>닉<input text='text' size=10 id='nick' name='nick' value="+board.nick+" readonly></td>"+
				              "<td>번호<input type='text' size=5 id='qna_no' value="+board.qna_no+" name='qna_no' readonly></td>"+
			                  "<td align ='right'>조회수:"+board.viewnum+"</td>"+
			                  "<td align ='right'>"+board.reg_Date+" </td></tr>").appendTo(table);
			        $("<tr>").html
			        ("<td colspan='4'><textarea name='qna_content' class='form-control' id='qna_content'rows='7'cols='85' readonly>"+board.qna_content+
	        		 "</textarea></td></tr>").appendTo(table);
			        
			        
			        
			        $("[name='qna_no']").val(board.qna_no);
			        
			        
			        
		 		 	var nick = $("#nick").val();
		 		 	$("[name='qnaReply_nick']").val(nickname);
		 		 	alert(nickname+","+nick);
		 		 	if(nickname!=nick){
		 		 		$("#insert").attr("disabled","disabled");
		 		 		$("#update").attr("disabled","disabled");
		 		 		$("#delete").attr("disabled","disabled");
		 		 	}

			},
		    error: function(jqXHR, textStatus, errorThrown) {
				alert("오호라.. 오류다!");
				console.log(textStatus);
				console.log(errorThrown);
			}
			
			
					
		});

		
		function insertForm(){
			$("#qna_title").prop("readonly",false)
			$("#qna_content").prop("readonly",false)
		}
		
		
			
			
		
		
		function deleteQna() {
			alert(no+"번 삭제");
			location.href = contextRoot + "/board/delete.do?qna_no=" + no;			
			
		}
		
		
		
		
		function updateForm(){
			var content =$("#qna_content").val();
			var title = $("#qna_title").val();
			$.ajax(contextRoot +'/board/update.do?qna_no=' + no+"&qna_title="+title+"&qna_content="+content,{
			    dataType: 'json',
				method: 'GET'
				
				
		  })
		  
		};
		
		
		
	  
		$.ajax(contextRoot + '/board/selectReply.do?qna_no='+no,{
			dataType: 'json',
			method: 'GET',
			async: false,
			success: function(resultObj) {
				var table = $("#reply_table");
				var idx = 0;
			    for (var reply of resultObj.data) {
			    	$("<tr>")
				      .html("<td align='center'>"+reply.qnaReply_nick+"</td>"+
				             "<td align='center'>"+reply.qnaReply_date+"</td></tr>").appendTo(table);
				    $("<tr>")
				      .html("<td colspan='2'><textarea class='form-control' rows='2' readonly>"+reply.qnaReply_content+"</textarea></td></tr>").appendTo(table);
				    $("<tr>")
				      .html("<td colspan='2' align='center'>"+
				           "<input type='button' id='replyupdate" + idx +"' class='btn btn-default' data-target='#layerpop' data-toggle='modal' value='수정'"+
				            "onclick='updateReply("+reply.qnaReply_no+")'>&nbsp"+
				              "<input type='button' id='replydelete" + idx +"' class='btn btn-default' value='삭제'onclick='deleteReply("+reply.qnaReply_no+")'></td></tr>").appendTo(table);   
				    	
				   
				    var reply_nick =reply.qnaReply_nick;
		 		 	if(nickname!=reply_nick){
		 		 		$("#replyupdate" + idx).attr("disabled","disabled");
				 		$("#replydelete" + idx).attr("disabled","disabled");
		            }
		 		 	
		 		 	idx++;
			    }
			} 
		  });
		
		function deleteReply(del_no){
			alert("댓글"+del_no+"번 삭제");
			location.href = contextRoot + "/board/deleteReply.do?qnaReply_no=" + del_no + "&qna_no=" + no;
		}
		
		function updateReply(qnaReply_no) {
			var df=document.ReplyForm;
			df.qna_no.value = no;
			df.qnaReply_no.value = qnaReply_no
			
		}
		
		
		
		
  </script>	
	
	
	
	
	
	<div class="modal fade" id="layerpop" >
    <div class="modal-dialog">
    <div class="modal-content">
      <form action="/hair/board/updateReply.do" method="post" name="ReplyForm">
      <!-- header -->
      <div class="modal-header">
        <!-- 닫기(x) 버튼 -->
        <button type="button" class="close" data-dismiss="modal">×</button>
        <!-- header title -->
        <h4 class="modal-title">댓글 수정</h4>
      </div>
      <!-- body -->
      <div class="modal-body">
      <input type="text" class="form-control"  placeholder="댓글을 수정하세요" name="qnaReply_content">
      <input type="hidden" name="qnaReply_no"/>
      <input type="hidden" name="qna_no"/>
      </div>
      <!-- Footer -->
      <div class="modal-footer">
        <input class="btn btn-default" type="submit" value="수정">
        </form>
      </div>
    </div>
  </div>
</div>
	
		
		
		
  </div>
  <div id="righter"></div>
</div>
</body>
</html>